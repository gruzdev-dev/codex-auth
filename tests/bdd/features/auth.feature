Feature: Жизненный цикл сессии пользователя
  Как Пациент системы Codex
  Я хочу регистрироваться, входить в систему и поддерживать сессию активной
  Чтобы безопасно работать с медицинскими документами без постоянного ввода пароля

  Background:
    Given сервис аутентификации запущен
    And база данных очищена

  Scenario: Полный цикл: Регистрация, Вход, Доступ и Обновление токена
    # 1. Регистрация
    Given в системе нет пользователя "patient@example.com"
    When пользователь регистрируется с email "patient@example.com" и паролем "strongPass123"
    Then регистрация должна пройти успешно

    # 2. Вход (Login)
    When пользователь входит в систему с email "patient@example.com" и паролем "strongPass123"
    Then система возвращает пару токенов

    # 3. Проверка доступа (Validate) - Эмуляция авторизации
    When пользователь обращается к "защищенному ресурсу" с полученным токеном
    Then доступ должен быть разрешен
    And идентификатор пользователя в заголовке ответа не должен быть пустым

    # 4. Обновление сессии (Refresh)
    When пользователь обновляет токены используя Refresh токен
    Then система возвращает новую пару токенов
    And новые токены должны отличаться от старых
    And старый Access токен должен стать невалидным через 5 секунд